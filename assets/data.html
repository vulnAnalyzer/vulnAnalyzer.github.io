<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Vulnerability API Table</title>
	<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
	<style>
		body {
			font-family: Arial, sans-serif;
			padding: 20px;
		}

		#severityFilter {
			margin-bottom: 10px;
		}

		td.api-cell,
		td.description-cell {
			max-width: 200px;
			max-height: 6em;
			overflow-y: auto;
			overflow-x: hidden;
			white-space: pre-wrap;
			word-break: break-word;
		}

		table.dataTable td {
			white-space: normal !important;
		}

		table.dataTable {
			table-layout: fixed;
		}
	</style>
</head>
<body>

	<label for="severityFilter">Filter by Severity:</label>
	<select id="severityFilter">
		<option value="">All</option>
		<option value="Low">Low</option>
		<option value="Moderate">Moderate</option>
		<option value="High">High</option>
		<option value="Critical">Critical</option>
	</select>

	<div>
		<table id="vulnerabilityTable" class="display" style="width:100%">
			<thead>
				<tr>
					<th>Package</th>
					<th>Patched Version</th>
					<th>CVE</th>
					<th>CWE</th>
					<th>Severity</th>
					<th>Semver</th>
					<th>API</th>
					<th>Description</th>
					<th>URL</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

	<script>
		let allData = [];

		function renderTable() {
			const severityFilter = $('#severityFilter').val();

			const filteredData = allData.filter(item => {
				if (severityFilter) {
					return item[4] === severityFilter;
				}
				return true;
			});

			$('#vulnerabilityTable').DataTable({
				destroy: true,
				data: filteredData,
				deferRender: true,
				pageLength: 3,        // 每页3条
				paging: true,         // 启用分页
				scrollY: '',          // 禁用滚动
				scrollCollapse: false,
				scrollX: false,
				scroller: false,
				language: {
					searchPlaceholder: "Search by CVE or CWE..."
				},
				columns: [
					{ title: "Package", data: 0, width: '7%' },
					{ title: "Patched Version", data: 1, width: '5%' },
					{ title: "CVE", data: 2, width: '10%' },
					{ title: "CWE", data: 3, width: '10%' },
					{ title: "Severity", data: 4, width: '5%' },
					{ title: "Semver", data: 5, width: '10%' },
					{ title: "API", data: 6 },
					{ title: "Description", data: 7 },
					{
						title: "URL",
						data: 8,
						width: "2%",
						render: function (data) {
							return `<a href="${data}" target="_blank">Link</a>`;
						}
					}
				],
				createdRow: function (row, data, dataIndex) {
					$('td', row).eq(6).addClass('api-cell');
					$('td', row).eq(7).addClass('description-cell');
				}
			});
		}

		$(document).ready(function () {
			$.getJSON('../data/RQ1/data.json', function (json) {
				allData = json.flatMap(entry => {
					return entry.vulnerableAPI.map(api => [
						entry.name,
						entry.patchedVersion,
						entry.CVE,
						entry.CWE,
						entry.severityLevel,
						entry.semver,
						api.API,
						api.description,
						entry.URL
					]);
				});

				renderTable();

				$('#severityFilter').on('change', renderTable);
			});
		});
	</script>
</body>
</html>
