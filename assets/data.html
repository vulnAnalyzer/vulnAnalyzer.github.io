<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transposed Vulnerability Table</title>
<style>
	body {
		font-family: Arial, sans-serif;
		padding: 20px;
	}
	#severityFilter {
		margin-bottom: 15px;
	}
	table {
		border-collapse: collapse;
		width: 100%;
	}
	th, td {
		border: 1px solid #ccc;
		padding: 8px;
		text-align: left;
		vertical-align: top;
	}
	th {
		background-color: #f2f2f2;
		width: 150px;
	}
	td.ellipsis {
		max-width: 200px;
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis;
		position: relative;
	}
	td.ellipsis:hover::after {
		content: attr(data-fulltext);
		position: absolute;
		top: 100%;
		left: 0;
		background: rgba(0, 0, 0, 0.85);
		color: #fff;
		padding: 6px 10px;
		border-radius: 5px;
		white-space: pre-wrap;
		max-width: 400px;
		z-index: 1000;
		pointer-events: none;
	}
	.pagination {
		margin-top: 15px;
	}
	.pagination button {
		padding: 6px 12px;
		margin-right: 5px;
	}
</style>
</head>
<body>

<label for="severityFilter">Filter by Severity:</label>
<select id="severityFilter">
	<option value="">All</option>
	<option value="Low">Low</option>
	<option value="Moderate">Moderate</option>
	<option value="High">High</option>
	<option value="Critical">Critical</option>
</select>

<div id="tableContainer"></div>
<div class="pagination" id="paginationControls"></div>

<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script>
	let allData = [];
	let currentPage = 0;
	const pageSize = 1;

	const headers = [
		"Package", "Patched Version", "CVE", "CWE",
		"Severity", "Semver", "API", "Description", "URL"
	];

	function renderTransposedTable(dataChunk) {
		let html = `<table><tbody>`;

		// 行循环
		for (let i = 0; i < headers.length; i++) {
			html += `<tr><th>${headers[i]}</th>`;
			for (let j = 0; j < dataChunk.length; j++) {
				let value = dataChunk[j][i];

				if (headers[i] === "URL") {
					html += `<td><a href="${value}" target="_blank">Link</a></td>`;
				} else {
					const escaped = String(value).replace(/"/g, '&quot;');
					html += `<td class="ellipsis" data-fulltext="${escaped}">${escaped}</td>`;
				}
			}
			html += `</tr>`;
		}
		html += `</tbody></table>`;

		document.getElementById('tableContainer').innerHTML = html;
	}

	function renderPagination(totalPages) {
		let html = '';
		for (let i = 0; i < totalPages; i++) {
			html += `<button ${i === currentPage ? 'disabled' : ''} onclick="goToPage(${i})">${i + 1}</button>`;
		}
		document.getElementById('paginationControls').innerHTML = html;
	}

	function goToPage(page) {
		currentPage = page;
		render();
	}

	function render() {
		const severity = $('#severityFilter').val();
		const filtered = severity ? allData.filter(d => d[4] === severity) : allData;

		const totalPages = Math.ceil(filtered.length / pageSize);
		const start = currentPage * pageSize;
		const end = start + pageSize;
		const chunk = filtered.slice(start, end);

		renderTransposedTable(chunk);
		renderPagination(totalPages);
	}

	$(document).ready(function () {
		$.getJSON('../data/RQ1/data.json', function (json) {
			allData = json.flatMap(entry => {
				return entry.vulnerableAPI.map(api => [
					entry.name,
					entry.patchedVersion,
					entry.CVE,
					entry.CWE,
					entry.severityLevel,
					entry.semver,
					api.API,
					api.description,
					entry.URL
				]);
			});

			render();

			$('#severityFilter').on('change', function () {
				currentPage = 0;
				render();
			});
		});
	});
</script>
</body>
</html>
