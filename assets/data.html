<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Transposed Vulnerability Table</title>
<style>
	body {
		font-family: Arial, sans-serif;
		padding: 20px;
	}
	#severityFilter {
		margin-bottom: 15px;
	}
	table {
		border-collapse: collapse;
		width: 100%;
	}
	th, td {
		border: 1px solid #ccc;
		padding: 8px;
		text-align: left;
		vertical-align: top;
	}
	th {
		background-color: #f2f2f2;
		width: 150px;
	}
	.pagination {
		margin-top: 15px;
	}
	.pagination button {
		padding: 6px 12px;
		margin-right: 5px;
	}
	/* 弹出层样式 */
	#modal {
		display: none;
		position: fixed;
		top: 0; left: 0; right: 0; bottom: 0;
		background-color: rgba(0,0,0,0.5);
		justify-content: center;
		align-items: center;
		z-index: 999;
	}
	#modalContent {
		background: #fff;
		padding: 20px;
		border-radius: 8px;
		max-width: 600px;
		max-height: 80%;
		overflow-y: auto;
		box-shadow: 0 4px 10px rgba(0,0,0,0.3);
	}
	#modalContent h3 {
		margin-top: 0;
	}
	#closeModal {
		margin-top: 20px;
	}
</style>
</head>
<body>

<label for="severityFilter">Filter by Severity:</label>
<select id="severityFilter">
	<option value="">All</option>
	<option value="Low">Low</option>
	<option value="Moderate">Moderate</option>
	<option value="High">High</option>
	<option value="Critical">Critical</option>
</select>

<div id="tableContainer"></div>
<div class="pagination" id="paginationControls"></div>

<!-- 弹出层 -->
<div id="modal">
	<div id="modalContent">
		<h3>Details</h3>
		<div id="detailsText"></div>
		<button id="closeModal">Close</button>
	</div>
</div>

<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script>
	let allData = [];
	let currentPage = 0;
	const pageSize = 1;

	const headers = [
		"Package", "Patched Version", "CVE", "CWE",
		"Severity", "Semver", "Details", "URL"
	];

	function renderTransposedTable(dataChunk) {
		let html = `<table><tbody>`;

		for (let i = 0; i < headers.length; i++) {
			html += `<tr><th>${headers[i]}</th>`;
			for (let j = 0; j < dataChunk.length; j++) {
				let value = dataChunk[j][i];

				if (headers[i] === "URL") {
					html += `<td><a href="${value}" target="_blank">Link</a></td>`;
				} else if (headers[i] === "Details") {
					html += `<td><button onclick="showDetails(${currentPage * pageSize + j})">View</button></td>`;
				} else {
					html += `<td>${value}</td>`;
				}
			}
			html += `</tr>`;
		}
		html += `</tbody></table>`;

		document.getElementById('tableContainer').innerHTML = html;
	}

	function renderPagination(totalPages) {
		let html = '';
		for (let i = 0; i < totalPages; i++) {
			html += `<button ${i === currentPage ? 'disabled' : ''} onclick="goToPage(${i})">${i + 1}</button>`;
		}
		document.getElementById('paginationControls').innerHTML = html;
	}

	function goToPage(page) {
		currentPage = page;
		render();
	}

	function render() {
		const severity = $('#severityFilter').val();
		const filtered = severity ? allData.filter(d => d[4] === severity) : allData;

		const totalPages = Math.ceil(filtered.length / pageSize);
		const start = currentPage * pageSize;
		const end = start + pageSize;
		const chunk = filtered.slice(start, end);

		renderTransposedTable(chunk);
		renderPagination(totalPages);
	}

	function showDetails(index) {
		const item = allData[index];
		const api = item[6];
		const desc = item[7];
		$('#detailsText').html(`<strong>API:</strong><pre>${api}</pre><strong>Description:</strong><pre>${desc}</pre>`);
		$('#modal').css('display', 'flex');
	}

	$('#closeModal').on('click', function () {
		$('#modal').hide();
	});

	$(document).ready(function () {
		$.getJSON('../data/RQ1/data.json', function (json) {
			allData = json.flatMap(entry => {
				return entry.vulnerableAPI.map(api => [
					entry.name,
					entry.patchedVersion,
					entry.CVE,
					entry.CWE,
					entry.severityLevel,
					entry.semver,
					'Details',  // 占位符，用于按钮列
					api.API,
					api.description,
					entry.URL
				]);
			});

			render();

			$('#severityFilter').on('change', function () {
				currentPage = 0;
				render();
			});
		});
	});
</script>
</body>
</html>
