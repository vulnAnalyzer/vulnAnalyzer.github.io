<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vulnerability API Table</title>
<link rel="stylesheet" href="/assets/css/jquery.dataTables.min.css">
<style>
	body{font-family:Arial, sans-serif;padding:20px;}

	#severityFilter{margin-bottom:10px;}

	/* 表格整体排版 */
	table.dataTable{table-layout:fixed;}
	table.dataTable td{white-space:normal!important;}

	/* API & Description 单元格：不出现滚动条，超长省略号 */
	td.api-cell,
	td.description-cell{
		max-width:200px;          /* 只限制宽度，不限制高度 */
		overflow:hidden;
		white-space:nowrap;
		text-overflow:ellipsis;
		position:relative;
	}

	/* 鼠标悬停时的 tooltip */
	td.api-cell:hover::after,
	td.description-cell:hover::after{
		content:attr(data-fulltext);
		position:absolute;
		top:100%; left:0;
		background:rgba(0,0,0,.85);
		color:#fff;
		padding:6px 10px;
		border-radius:5px;
		white-space:pre-wrap;
		max-width:400px;          /* 控制宽度，依旧不出现滚动条 */
		z-index:1000;
		pointer-events:none;
	}
</style>
</head>
<body>

<label for="severityFilter">Filter by Severity:</label>
<select id="severityFilter">
	<option value="">All</option>
	<option value="Low">Low</option>
	<option value="Moderate">Moderate</option>
	<option value="High">High</option>
	<option value="Critical">Critical</option>
</select>

<table id="vulnerabilityTable" class="display" style="width:100%">
	<thead>
		<tr>
			<th>Package</th><th>Patched Version</th><th>CVE</th><th>CWE</th>
			<th>Severity</th><th>Semver</th><th>API</th><th>Description</th><th>URL</th>
		</tr>
	</thead>
	<tbody></tbody>
</table>

<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script src="/assets/js/jquery.dataTables.min.js"></script>
<script>
let allData=[];

function renderTable(){
	const severity=$('#severityFilter').val();
	const data=allData.filter(r=>severity? r[4]===severity : true);

	$('#vulnerabilityTable').DataTable({
		destroy:true,
		data:data,
		deferRender:true,
		pageLength:3,
		paging:true,
		scrollY:false,
		scrollCollapse:false,
		scrollX:false,
		scroller:false,
		language:{searchPlaceholder:"Search by CVE or CWE..."},
		columns:[
			{data:0,width:'7%'},{data:1,width:'5%'},{data:2,width:'10%'},
			{data:3,width:'10%'},{data:4,width:'5%'},{data:5,width:'10%'},
			{data:6},{data:7},
			{data:8,width:'2%',render:data=>`<a href="${data}" target="_blank">Link</a>`}
		],
		createdRow:(row,data)=>{
			$('td',row).eq(6).addClass('api-cell').attr('data-fulltext',data[6]);
			$('td',row).eq(7).addClass('description-cell').attr('data-fulltext',data[7]);
		}
	});
}

$(document).ready(()=>{
	$.getJSON('../data/RQ1/data.json',json=>{
		allData=json.flatMap(e=>e.vulnerableAPI.map(api=>[
			e.name,e.patchedVersion,e.CVE,e.CWE,e.severityLevel,
			e.semver,api.API,api.description,e.URL
		]));
		renderTable();
		$('#severityFilter').on('change',renderTable);
	});
});
</script>
</body>
</html>
